	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.15" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Python Coroutine &middot; Hugo Blog </title>

  
  <link rel="stylesheet" href="http://danigong.github.io/css/poole.css">
  <link rel="stylesheet" href="http://danigong.github.io/css/syntax.css">
  <link rel="stylesheet" href="http://danigong.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://danigong.github.io/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="http://danigong.github.io/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Hugo Blog" />
</head>

	<body class="">
		<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://danigong.github.io/"><h1>Hugo Blog</h1></a>
      <p class="lead">
       Hugo is one of the most popular open-source static site generators. With its amazing speed and flexibility, Hugo makes building websites fun again. 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="http://danigong.github.io/">Home</a> </li>
      
        <li><a href="http://danigong.github.io/"> Home </a></li>
      
        <li><a href="https://github.com/laozhu"> Works </a></li>
      
        <li><a href="http://danigong.github.io/tags/"> Tags </a></li>
      
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1>Python Coroutine</h1>
			  <span class="post-date">Mon, Aug 15, 2016</span>
			      

<h2 id="协程:596b597b96b8798ca4833589eec0b9fc">协程</h2>

<h3 id="协程-又称微线程-纤程-英文名coroutine:596b597b96b8798ca4833589eec0b9fc">协程，又称微线程，纤程。英文名Coroutine。</h3>

<p>协程的概念很早就提出来了，但直到最近几年才在某些语言（如Lua）中得到广泛应用。</p>

<p>子程序，或者称为函数，在所有语言中都是层级调用，比如A调用B，B在执行过程中又调用了C，C执行完毕返回，B执行完毕返回，最后是A执行完毕。</p>

<p>所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。</p>

<p>子程序调用总是一个入口，一次返回，调用顺序是明确的。而协程的调用和子程序不同。</p>

<p>协程看上去也是子程序，但执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行。</p>

<p>注意，在一个子程序中中断，去执行其他子程序，不是函数调用，有点类似CPU的中断。比如子程序A、B：</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%">def A():
    print &#39;1&#39;
    print &#39;2&#39;
    print &#39;3&#39;

def B():
    print &#39;x&#39;
    print &#39;y&#39;
    print &#39;z&#39;
</pre></div>

<p>假设由协程执行，在执行A的过程中，可以随时中断，去执行B，B也可能在执行过程中中断再去执行A，结果可能是：</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%">1
2
x
y
3
z
</pre></div>

<p>但是在A中是没有调用B的，所以协程的调用比函数调用理解起来要难一些。</p>

<p>看起来A、B的执行有点像多线程，但协程的特点在于是一个线程执行，那和多线程比，协程有何优势？</p>

<p>最大的优势就是协程极高的执行效率。因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。</p>

<p>第二大优势就是不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。</p>

<p>因为协程是一个线程执行，那怎么利用多核CPU呢？最简单的方法是多进程+协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。</p>

<p>Python对协程的支持还非常有限，用在generator中的yield可以一定程度上实现协程。虽然支持不完全，但已经可以发挥相当大的威力了。</p>

<p>来看例子：</p>

<p>传统的生产者-消费者模型是一个线程写消息，一个线程取消息，通过锁机制控制队列和等待，但一不小心就可能死锁。</p>

<p>如果改用协程，生产者生产消息后，直接通过yield跳转到消费者开始执行，待消费者执行完毕后，切换回生产者继续生产，效率极高：</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #f92672">import</span> <span style="color: #f8f8f2">time</span>

<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">consumer</span><span style="color: #f8f8f2">():</span>
    <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;&#39;</span>
    <span style="color: #66d9ef">while</span> <span style="color: #f8f8f2">True:</span>
        <span style="color: #f8f8f2">n</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">yield</span> <span style="color: #f8f8f2">r</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f92672">not</span> <span style="color: #f8f8f2">n:</span>
            <span style="color: #66d9ef">return</span>
        <span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;[CONSUMER] Consuming %s...&#39;</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">n)</span>
        <span style="color: #f8f8f2">time</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">sleep(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
        <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;200 OK&#39;</span>

<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">produce</span><span style="color: #f8f8f2">(c):</span>
    <span style="color: #f8f8f2">c</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">next()</span>
    <span style="color: #f8f8f2">n</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span>
    <span style="color: #66d9ef">while</span> <span style="color: #f8f8f2">n</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2">:</span>
        <span style="color: #f8f8f2">n</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">n</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">1</span>
        <span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;[PRODUCER] Producing %s...&#39;</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">n)</span>
        <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">c</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">send(n)</span>
        <span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;[PRODUCER] Consumer return: %s&#39;</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">r)</span>
    <span style="color: #f8f8f2">c</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">close()</span>

<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">__name__</span><span style="color: #f92672">==</span><span style="color: #e6db74">&#39;__main__&#39;</span><span style="color: #f8f8f2">:</span>
    <span style="color: #f8f8f2">c</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">consumer()</span>
    <span style="color: #f8f8f2">produce(c)</span>
</pre></div>

<p>执行结果：</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Producing 1...
<span style="color: #75715e">[</span><span style="color: #a6e22e">CONSUMER</span><span style="color: #75715e">]</span> Consuming 1...
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Consumer return: 200 OK
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Producing 2...
<span style="color: #75715e">[</span><span style="color: #a6e22e">CONSUMER</span><span style="color: #75715e">]</span> Consuming 2...
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Consumer return: 200 OK
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Producing 3...
<span style="color: #75715e">[</span><span style="color: #a6e22e">CONSUMER</span><span style="color: #75715e">]</span> Consuming 3...
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Consumer return: 200 OK
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Producing 4...
<span style="color: #75715e">[</span><span style="color: #a6e22e">CONSUMER</span><span style="color: #75715e">]</span> Consuming 4...
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Consumer return: 200 OK
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Producing 5...
<span style="color: #75715e">[</span><span style="color: #a6e22e">CONSUMER</span><span style="color: #75715e">]</span> Consuming 5...
<span style="color: #75715e">[</span><span style="color: #a6e22e">PRODUCER</span><span style="color: #75715e">]</span> Consumer return: 200 OK
</pre></div>

<p>注意到consumer函数是一个generator（生成器），把一个consumer传入produce后：</p>

<p>首先调用c.next()启动生成器；</p>

<p>然后，一旦生产了东西，通过c.send(n)切换到consumer执行；</p>

<p>consumer通过yield拿到消息，处理，又通过yield把结果传回；</p>

<p>produce拿到consumer处理的结果，继续生产下一条消息；</p>

<p>produce决定不生产了，通过c.close()关闭consumer，整个过程结束。</p>

<p>整个流程无锁，由一个线程执行，produce和consumer协作完成任务，所以称为“协程”，而非线程的抢占式多任务。</p>

<p>最后套用Donald Knuth的一句话总结协程的特点：</p>

<p>“子程序就是协程的一种特例。”</p>

			</div>

			
		</div>

  </body>
</html>
